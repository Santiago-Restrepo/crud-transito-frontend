import Head from 'next/head'
import { useState, useMemo, useEffect } from 'react'
import MaterialReactTable from 'material-react-table';
import type { MRT_ColumnDef } from 'material-react-table';
//Components
import { TableSelector } from '@/components/TableSelector'
import { TableModal } from '@/components/TableModal'
//Icons
import {AiFillDelete, AiFillEdit, AiOutlineLoading3Quarters} from 'react-icons/ai'
//Toast
import { ToastContainer, toast } from 'react-toastify';
import 'react-toastify/dist/ReactToastify.css';
//Data
import tablesInfo from '@/data/tables'
import { error } from 'console';
//Types


interface HomeProps {
  data: any
}

interface ModalStateProps {
  show: boolean,
  data: any
}
  
export default function Home({
  data
}: HomeProps) {
  const [tables, setTables] = useState([...tablesInfo]);
  const [selectedTable, setSelectedTable] = useState(tables[0]);
  const [tableData, setTableData] = useState(data);
  const [loading, setLoading] = useState(false);
  const columns = useMemo(
    () => {
      const firstRow = tableData[0]
      const columns: MRT_ColumnDef[] = []
      for (const key in firstRow) {
        columns.push({
          accessorKey: key,
          header: key,
        })
      }
      return columns
    },
    [tableData]
  );
  const [modal, setModal] = useState<ModalStateProps>({
    show: false,
    data: null
  })

  const fetchTableData = async (url: string) => {
    const res = await fetch(url)
    const data = await res.json()
    return data
  }

  const refetchTableData = async () => {
    setLoading(true)
    const newTableData = await fetchTableData(`https://crud-transito-backend.vercel.app${selectedTable.path}`);
    setTableData(newTableData)
    setLoading(false)
  }

  const handleChangeTable = async (index: number) => {
    if(tables[index].selected) return;
    setLoading(true)
    const newTableData = await fetchTableData(`https://crud-transito-backend.vercel.app${tables[index].path}`);
    setTableData(newTableData)
    const newTables = tables.map((table, i) => {
      if(i === index) return {...table, selected: true}
      return {...table, selected: false}
    })
    setTables(newTables)
    setSelectedTable(tables[index])
    setLoading(false)
  }

  const handleEdit = async (row: any) => {
    const data = row.original;
    setModal({
      show: true,
      data
    })
  }

  const handleAdd = async () => {
    setModal({
      show: true, 
      data: null
    })
  }

  const handleDelete = async (id: number) => {
    const res = await fetch(`https://crud-transito-backend.vercel.app${selectedTable.path}/${id}`, {
      method: 'DELETE',
      headers: {
          'Content-Type': 'application/json'
      }
    })
    const data = await res.json()
    if(data.error) throw new Error(data.message)
    await refetchTableData()
  }

  return (
    <>
      <Head>
        <title>Create Next App</title>
        <meta name="description" content="Generated by create next app" />
        <meta name="viewport" content="width=device-width, initial-scale=1" />
        <link rel="icon" href="/favicon.ico" />
      </Head>
      <main className='p-5'>
        <h1 className="text-2xl font-bold text-center text-gray-200">Selecciona una tabla</h1>
        <div className="tableButtons flex flex-wrap justify-center">
          {
            tables.map((table, index) => (
              <TableSelector
                key={table.name}
                title={table.name}
                icon={table.icon}
                onClick={() => {
                  handleChangeTable(index)
                }} 
                selected={table.selected}
              />
            ))
          }
        </div>
        {
          loading ? <h1 className="text-xl font-bold text-center text-gray-100">Cargando...</h1> : 
          (
            <div className="table w-full overflow-x-scroll">
              <MaterialReactTable
                columns={columns}
                data={tableData}
                muiTableContainerProps={{
                  sx: { maxHeight: '600px', maxWidth: '90vw' }, //give the table a max height
                }}
                enableEditing={true}
                renderRowActions={({ row, table }) => {
                  const id : number = row.getValue('id')
                  return (
                    <div className='buttons flex'>
                      <button
                        className='mr-2 bg-gray-400 text-white p-2 rounded-md'
                        onClick={() => handleEdit(row)}
                      >
                        <AiFillEdit size={20}/>
                      </button>
                      <button
                        className='bg-red-500 text-white p-2 rounded-md'
                        onClick={async () => {
                          if(id){
                            toast.promise(
                              handleDelete(id),
                              {
                                pending: {
                                  render(){
                                    return "Cargando..."
                                  },
                                  icon: false,
                                },
                                success: 'Registro eliminado correctamente',
                                error: {
                                  render({data}){
                                    // When the promise reject, data will contains the error
                                    const message = data instanceof Error ? data.message : "Error"
                                    return message
                                  }
                                }
                              }
                            )
                          }
                        }}
                      >
                        <AiFillDelete size={20}/>
                      </button>
                    </div>
                  )
                }}
                renderTopToolbarCustomActions={() => (
                  <button
                    className='bg-green-500 text-white font-medium p-2 rounded-md'
                    onClick={handleAdd}
                  >
                    Crear nuevo
                  </button>
                )}
              />
            </div>
          )
        }
        <TableModal
          show={modal.show}
          data={modal.data}
          toast={toast}
          selectedTable={selectedTable}
          setTables={setTables}
          refetchTableData={refetchTableData}
          onClose={() => setModal({...modal, show: false})}
        />
        <ToastContainer />
      </main>
    </>
  )
}

//Get server side props
export async function getServerSideProps() {
  try {
    const url = 'https://crud-transito-backend.vercel.app'
    const res = await fetch(`${url}/api/infraccion`)
    const data = await res.json()
    return {
      props: {
        data
      }
    }
  } catch (error) {
    console.log(error)
    return{
      props: {
        data: []
      }
    }
  }
}
